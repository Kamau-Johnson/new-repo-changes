<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>EduGrade | Teacher Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='teacher_dashboard.css') }}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="message-box" id="messageBox"></div>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <i class="logo-icon fas fa-graduation-cap"></i>
                    <div class="logo-text"><h1>EDUGRADE +</h1><p>Track. Grade. Grow.</p></div>
                </div>
            </div>
            <nav class="sidebar-content">
                <div class="nav-items">
                    <a href="#" class="nav-item active" onclick="showSection('dashboard')" data-section="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                    <div class="management-label">Management</div>
                    <a href="#" class="nav-item" onclick="showSection('all_students')" data-section="all_students"><i class="fas fa-users"></i><span>All Students</span></a>
                    <a href="#" class="nav-item" onclick="showSection('marks_entry')" data-section="marks_entry"><i class="fas fa-book-open-reader"></i><span>Marks Entry</span></a>
                    <a href="#" class="nav-item" onclick="showSection('generate_report')" data-section="generate_report"><i class="fas fa-chart-bar"></i><span>Generate Report</span></a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info"><i class="fas fa-user-circle"></i><span>{{ teacher_name }}</span></div>
                <div class="logout-link"><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                <div id="dashboard" class="content-section active">
                    <div class="welcome-card"><h1>Welcome, {{ teacher_name }}!</h1><p>Here's a summary of your system status.</p></div>
                    <div class="info-cards">
                        <div class="info-card"><h3>TOTAL STUDENTS</h3><div class="number-box" id="totalStudentsCount">{{ total_students }}</div><p>Students currently enrolled</p></div>
                        <div class="info-card"><h3>TOTAL TEACHERS</h3><div class="number-box">1</div><p>Teachers in the system</p></div>
                    </div>
                </div>
                
                <div id="all_students" class="content-section">
                    <!-- Student List View -->
                    <div id="student-list-container">
                        <div class="content-header"><h2><i class="fas fa-users"></i> All Students</h2><p>View, add, and manage all students in the system.</p></div>
                        <div class="data-container">
                            <div class="table-controls">
                                <div class="search-container"><input type="text" id="studentSearch" placeholder="Search by name or admission no..." class="search-input"><i class="fas fa-search search-icon"></i></div>
                                <button class="btn btn-primary" onclick="showAddStudentForm()"><i class="fas fa-user-plus"></i> Add New Student</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead><tr><th>Student Name</th><th>Admission No.</th><th>Gender</th><th>Class</th><th>Actions</th></tr></thead>
                                    <tbody id="allStudentsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Add Student View -->
                    <div id="add-student-view" style="display: none;">
                        <div class="content-header"><h2><i class="fas fa-user-plus"></i> Add New Student</h2><p>Fill in the details for the new student.</p></div>
                        <div class="data-container">
                            <form id="addStudentForm">
                                <div class="form-grid">
                                    <div class="form-group"><label for="studname">Full Name *</label><input type="text" id="studname" name="studname" required></div>
                                    <div class="form-group"><label for="admno">Admission Number *</label><input type="text" id="admno" name="admno" required></div>
                                    <div class="form-group"><label for="gender">Gender *</label><select id="gender" name="gender" required><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
                                    <div class="form-group"><label for="dob">Date of Birth *</label><input type="date" id="dob" name="dob" required></div>
                                    <div class="form-group">
                                        <label for="classID">Assign to Grade *</label>
                                        <select id="classID" name="class" required>
                                            <option value="" disabled selected>Select a grade</option>
                                            <option value="Grade 1A">Grade 1A</option>
                                            <option value="Grade 1B">Grade 1B</option>
                                            <option value="Grade 2A">Grade 2A</option>
                                            <option value="Grade 2B">Grade 2B</option>
                                            <option value="Grade 3A">Grade 3A</option>
                                            <option value="Grade 3B">Grade 3B</option>
                                            <option value="Grade 4A">Grade 4A</option>
                                            <option value="Grade 4B">Grade 4B</option>
                                            <option value="Grade 5A">Grade 5A</option>
                                            <option value="Grade 5B">Grade 5B</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="hideAddStudentForm()">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Add Student</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div id="marks_entry" class="content-section">
                    <div id="marks-list-view">
                        <div class="content-header"><h2><i class="fas fa-book-open-reader"></i> Marks Entry</h2><p>Select a student to enter or update their marks.</p></div>
                        <div class="data-container">
                            <div class="table-controls"><div class="search-container"><input type="text" id="marksSearch" placeholder="Search students..." class="search-input"><i class="fas fa-search search-icon"></i></div></div>
                            <div class="table-responsive"><table class="data-table"><thead><tr><th>Student Name</th><th>Adm No.</th><th>Class</th><th>Mean Score</th><th>Remark</th><th>Actions</th></tr></thead><tbody id="marksTableBody"></tbody></table></div>
                        </div>
                    </div>
                    <div id="marks-entry-view" style="display: none;">
                        <div class="content-header"><h2 id="marksStudentName"></h2><p id="marksStudentDetails"></p></div>
                        <div class="data-container">
                            <form id="marksEntryForm">
                                <input type="hidden" id="marksEntryStudentId" name="studID">
                                <div class="form-grid">
                                    <div class="form-group"><label for="ovrscore">Overall Score</label><input type="number" id="ovrscore" name="ovrscore" required></div>
                                    <div class="form-group"><label for="meanscore">Mean Score</label><input type="number" id="meanscore" name="meanscore" required></div>
                                </div>
                                <div class="form-group"><label for="remark">Class Teacher's Remark</label><textarea id="remark" name="remark" rows="4"></textarea></div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="showMarksListView()">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Marks</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div id="generate_report" class="content-section">
                    <div class="content-header"><h2><i class="fas fa-chart-bar"></i> Generate Report</h2><p>Create and view end-of-term reports for students.</p></div>
                    <div class="data-container">
                        <div class="table-controls">
                            <div class="form-group"><label for="reportTermSelector">Select Term:</label><select id="reportTermSelector" class="search-input"><option value="Term 1">Term 1</option><option value="Term 2">Term 2</option><option value="Term 3">Term 3</option></select></div>
                            <div class="form-group"><label for="reportStudentSelector">Select Student:</label><select id="reportStudentSelector" class="search-input" required><option value="">-- Select --</option></select></div>
                            <div class="form-actions" style="border:none; padding:0; align-self:flex-end;"><button id="generateReportBtn" class="btn btn-primary" disabled><i class="fas fa-cogs"></i> Generate</button><button id="downloadPdfBtn" class="btn btn-success" style="display:none;"><i class="fas fa-file-pdf"></i> PDF</button></div>
                        </div>
                        <div id="reportCardContainer"><div class="placeholder-text"><i class="fas fa-file-invoice"></i><p>Select a term and student to generate a report.</p></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    // --- UTILITY FUNCTIONS ---
    async function updateDashboardData() {
        try {
            const response = await fetch('/api/dashboard_data');
            const data = await response.json();
            if (data.success) {
                document.getElementById('totalStudentsCount').textContent = data.total_students;
            }
        } catch (e) {
            console.error("Could not update dashboard data:", e);
        }
    }

    function showSection(id){
        const actions={
            'dashboard': updateDashboardData,
            'all_students':()=>{hideAddStudentForm();fetchAndRenderAllStudents()},
            'marks_entry':()=>showMarksListView(),
            'generate_report':()=>populateStudentDropdownsForReport()
        };
        document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        document.querySelector(`.nav-item[data-section="${id}"]`).classList.add('active');
        if(actions[id])actions[id]();
    }
    
    function showMessageBox(msg,type='success'){
        const b=document.getElementById('messageBox');
        b.innerHTML=`<i class="fas ${type==='success'?'fa-check-circle':'fa-times-circle'}"></i> ${msg}`;
        b.className=`message-box show ${type}`;
        setTimeout(()=>{b.className='message-box'},4000);
    }

    // --- ALL STUDENTS SECTION ---
    let allStudentsData = []; 

    function showAddStudentForm(){
        document.getElementById('student-list-container').style.display='none';
        document.getElementById('add-student-view').style.display='block';
    }
    
    function hideAddStudentForm(){
        document.getElementById('student-list-container').style.display='block';
        document.getElementById('add-student-view').style.display='none';
        document.getElementById('addStudentForm').reset();
    }

    function renderStudentsTable(studentsToRender) {
        const t = document.getElementById('allStudentsTableBody');
        t.innerHTML = ''; 

        if (studentsToRender && studentsToRender.length > 0) {
            studentsToRender.forEach(s => {
                t.innerHTML += `<tr><td>${s.studname}</td><td>${s.admno}</td><td>${s.gender}</td><td>${s.class}</td><td><button class="btn btn-danger" onclick="deleteStudent(${s.studID})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        } else {
            t.innerHTML = `<tr><td colspan="5" align="center">No students found matching your criteria.</td></tr>`;
        }
    }

    async function fetchAndRenderAllStudents(){
        const t = document.getElementById('allStudentsTableBody');
        t.innerHTML = `<tr><td colspan="5" align="center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>`;
        try {
            const r = await fetch('/api/get_students');
            const d = await r.json();
            if (d.success) {
                allStudentsData = d.students || [];
                renderStudentsTable(allStudentsData);
            } else {
                 t.innerHTML = `<tr><td colspan="5" align="center" style="color:red;">Error loading students.</td></tr>`;
            }
        } catch(e) {
            t.innerHTML = `<tr><td colspan="5" align="center" style="color:red;">An error occurred.</td></tr>`;
        }
    }

    document.getElementById('studentSearch').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const filteredStudents = allStudentsData.filter(student => {
            const nameMatch = student.studname.toLowerCase().includes(searchTerm);
            const admnoMatch = student.admno.toLowerCase().includes(searchTerm);
            return nameMatch || admnoMatch;
        });
        renderStudentsTable(filteredStudents);
    });

    document.getElementById('addStudentForm').addEventListener('submit',async function(e){
        e.preventDefault();
        const d=Object.fromEntries(new FormData(e.target).entries());
        try {
            const r=await fetch('/api/add_student',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            const j=await r.json();
            showMessageBox(j.message,j.success?'success':'error');
            if(j.success){
                hideAddStudentForm();
                fetchAndRenderAllStudents();
                updateDashboardData();
            }
        } catch(e) {
            showMessageBox('An unexpected error occurred while adding the student.','error');
        }
    });
    
    // REWRITTEN: This function now deletes directly without confirmation.
    async function deleteStudent(id) {
        try {
            const r = await fetch(`/api/delete_student/${id}`, { method: 'DELETE' });
            const j = await r.json();
            showMessageBox(j.message, j.success ? 'success' : 'error');
            if (j.success) {
                fetchAndRenderAllStudents();
                updateDashboardData();
            }
        } catch (e) {
            showMessageBox('An error occurred during deletion.', 'error');
        }
    }

    // --- MARKS ENTRY SECTION ---
    function showMarksListView(){
        document.getElementById('marks-list-view').style.display='block';
        document.getElementById('marks-entry-view').style.display='none';
        fetchAndRenderMarksTable();
    }

    async function fetchAndRenderMarksTable(){
        const t=document.getElementById('marksTableBody');
        t.innerHTML=`<tr><td colspan="6" align="center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>`;
        try{
            const r=await fetch('/api/get_marks_list');
            const d=await r.json();
            t.innerHTML='';
            if(d.success&&d.marks.length>0){
                d.marks.forEach(m=>{t.innerHTML+=`<tr><td>${m.studname}</td><td>${m.admno}</td><td>${m.class}</td><td>${m.meanscore||'N/A'}</td><td>${m.remark||'N/A'}</td><td><button class="btn btn-primary" onclick="openMarksEntryForStudent(${m.studID},'${m.studname}','${m.admno}')"><i class="fas fa-edit"></i></button></td></tr>`});
            } else {
                t.innerHTML=`<tr><td colspan="6" align="center">No students to mark.</td></tr>`;
            }
        } catch(e) {
            t.innerHTML=`<tr><td colspan="6" align="center" style="color:red;">Error loading data.</td></tr>`;
        }
    }
    
    async function openMarksEntryForStudent(id,name,admno){
        document.getElementById('marks-list-view').style.display='none';
        document.getElementById('marks-entry-view').style.display='block';
        const f=document.getElementById('marksEntryForm');
        f.reset();
        document.getElementById('marksStudentName').textContent=`Enter Marks for: ${name}`;
        document.getElementById('marksStudentDetails').textContent=`Admission No: ${admno}`;
        f.studID.value=id;
        try{
            const r=await fetch(`/api/get_single_mark/${id}`);
            const d=await r.json();
            if(d.success&&d.mark){
                f.ovrscore.value=d.mark.ovrscore;
                f.meanscore.value=d.mark.meanscore;
                f.remark.value=d.mark.remark;
            }
        } catch(e) {
            console.error("Could not fetch existing mark:",e);
        }
    }
    
    document.getElementById('marksEntryForm').addEventListener('submit',async function(e){
        e.preventDefault();
        const d=Object.fromEntries(new FormData(e.target).entries());
        try{
            const r=await fetch('/api/save_mark',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            const j=await r.json();
            showMessageBox(j.message,j.success?'success':'error');
            if(j.success) showMarksListView();
        } catch(e) {
            showMessageBox('An error occurred while saving marks.','error');
        }
    });

    // --- REPORT GENERATION SECTION ---
    async function populateStudentDropdownsForReport(){
        const s=document.getElementById('reportStudentSelector');
        s.innerHTML='<option value="">Loading...</option>';
        try{
            const r=await fetch('/api/get_students');
            const d=await r.json();
            s.innerHTML='<option value="">-- Select a student --</option>';
            if(d.success&&d.students.length>0){
                d.students.forEach(st=>{s.innerHTML+=`<option value="${st.studID}">${st.studname} (${st.admno})</option>`});
            }
        } catch(e) {
            s.innerHTML='<option value="">Error loading students</option>';
        }
    }

    document.getElementById('reportStudentSelector').addEventListener('change',e=>{
        document.getElementById('generateReportBtn').disabled=!e.target.value;
        document.getElementById('downloadPdfBtn').style.display='none';
    });

    document.getElementById('generateReportBtn').addEventListener('click',async()=>{
        const id=document.getElementById('reportStudentSelector').value;
        const term=document.getElementById('reportTermSelector').value;
        if(!id)return;
        const c=document.getElementById('reportCardContainer');
        c.innerHTML=`<div class="placeholder-text"><i class="fas fa-spinner fa-spin"></i> Generating...</div>`;
        try{
            const r=await fetch(`/api/generate_report?studID=${id}&term=${term}`);
            const d=await r.json();
            if(d.success && d.data){
                renderSimpleReportCard(d.data,c);
                document.getElementById('downloadPdfBtn').style.display='inline-flex';
            } else {
                c.innerHTML=`<div class="placeholder-text"><i class="fas fa-exclamation-circle"></i> ${d.message || 'No report data found for the selected student and term.'}</div>`;
                document.getElementById('downloadPdfBtn').style.display='none';
            }
        } catch(e) {
            c.innerHTML=`<div class="placeholder-text" style="color:red;">Error generating report.</div>`;
        }
    });

    function getGrade(score){
        if(score>=80)return'A';if(score>=70)return'B';if(score>=60)return'C';if(score>=50)return'D';return'E';
    }

    function renderSimpleReportCard(d,c){
        const g=getGrade(d.meanscore);
        c.innerHTML=`<div id="printableReport" class="report-card"><header class="report-header"><h1>EDUGRADE+ REPORT CARD</h1><p>End of ${d.term}, ${new Date().getFullYear()}</p></header><section class="student-details"><div><strong>Student:</strong> ${d.studname}</div><div><strong>Admission No:</strong> ${d.admno}</div><div><strong>Class:</strong> ${d.Classname}</div></section><section class="summary-section"><h3>Overall Performance</h3><div class="summary-grid" style="grid-template-columns:1fr 1fr 1fr"><div class="summary-box"><div><strong>Overall Score</strong></div><div>${d.ovrscore}</div></div><div class="summary-box"><div><strong>Mean Score</strong></div><div>${d.meanscore}</div></div><div class="summary-box"><div><strong>Grade</strong></div><div>${g}</div></div></div><div class="summary-box" style="margin-top:20px;text-align:left"><strong>Teacher's Remark:</strong><br><p>${d.remark}</p></div></section><footer class="report-footer"><div><p>_________________</p><p>Class Teacher</p></div><div><p>_________________</p><p>Principal</p></div></footer></div>`;
    }
    
    document.getElementById('downloadPdfBtn').addEventListener('click',()=>{
        const e=document.getElementById('printableReport');
        const n=e.querySelector('.student-details div').textContent.replace('Student:','').trim();
        const f=`Report-Card-${n}.pdf`;
        html2pdf().from(e).set({filename:f, margin: 0.5, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }).save();
    });
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded',()=>{
        showSection('dashboard');
    });
</script>
</body>
</html>